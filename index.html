<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase Maintenance Script</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: #111;
            color: #fff;
            text-align: center;
            padding: 20px;
        }
        select, input, button {
            width: 90%;
            max-width: 400px;
            padding: 12px;
            margin: 10px;
            font-size: 16px;
            border: none;
            border-radius: 12px;
            background: #333;
            color: white;
            outline: none;
        }
        
        button {
            background: #007aff;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s;
        }
        button:hover { background: #0051cb; }
        .copy-btn {
            background: #ff9500;
            margin-left: 10px;
        }
        .copy-btn:hover { background: #cc7700; }
        .hidden { display: none; }
        
        
        /* Full-page blur effect */
.overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(5px);
    z-index: 999;
    display: none;
}

/* Popup styling */
.popup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #222;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    width: 80%;
    max-width: 400px;
    z-index: 1000;
    display: none;
}

/* Close button */
.close-btn {
    position: absolute;
    top: -3px;
    right: -3px;
    width: 30px;
    height: 30px;
    background: darkred;
    color: white;
    border: none;
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    padding: 0;
}

.close-btn:hover {
    background: red;
}

.input-container {
    position: relative;
    display: flex;
    align-items: center;
}

#trackingID {
    width: 100%;
    padding-right: 30px; /* Space for the copy icon */
    text-align: left; /* Align text to the left */
}

.copy-icon {
    position: absolute;
    right: 20px;
    cursor: pointer;
    font-size: 18px;
    color: #333;
    background: none;
    border: none;
    outline: none;
}

.input-wallet {
    position: relative;
    display: flex;
    align-items: center;
    width: 100%;
}

#walletAddress {
    width: 100%;
    padding-right: 30px; /* Space for copy icon */
    text-align: left;
}
.hidden {
    display: none;
}
    </style> 
</head>
<body>
    <h2>Groww Social</h2>
    <p>Select a product and cryptocurrency to make the payment.</p>

       
        <select id="productSelect" onchange="checkForm()">
            <option value="" disabled selected>Select Product</option>
            <option value="Site Maintenance Script">Site Maintenance Script - $6</option>
            <option value="Premium Version">Premium Version - $12</option>
        </select>

    
    <select id="cryptoSelect" onchange="updateWallet(); checkForm()">
        <option value="" disabled selected>Select Cryptocurrency</option>
        <option value="BTC">Bitcoin (BTC)</option>
        <option value="USDT_TRON">USDT (TRC20)</option>
        <option value="USDT_ETH">USDT (ERC20)</option>
        <option value="BNB">BNB (BEP20)</option>
        <option value="TRX">Tron (TRX)</option>
        <option value="ETH">Ethereum (ETH)</option>
    </select>

       
    <div id="walletContainer" class="input-wallet hidden">
    <input type="text" id="walletAddress" readonly>
    <span class="copy-icon" onclick="copyAddress()">üìã</span>
</div>
    

    <h3>Payment Details</h3>
    <input type="text" id="transactionID" placeholder="Enter Transaction ID" oninput="checkForm()">
    <input type="text" id="domain" placeholder="Enter Your Domain" oninput="checkForm()">
    <input type="text" id="telegramUsername" placeholder="Enter Telegram Username" oninput="checkForm()">

    <button id="submitBtn" onclick="sendToTelegram()" disabled>Submit Payment</button>

    <!-- Overlay -->
    <div id="overlay" class="overlay"></div>

    <!-- Popup -->
    <div id="popup" class="popup">
    <button class="close-btn" onclick="closePopup()">‚úñ</button>
    <h3>‚úÖ Order Placed Successfully!</h3>
    <p>Your Order Tracking ID:</p>
    
    <div class="input-container">
    <input type="text" id="trackingID" readonly>
    <span class="copy-icon" onclick="copyTrackingID()">üìã</span>
</div>
    
    <button onclick="redirectToTracking()">üì¶ Track Order</button>
</div>

<script>
    const wallets = {
    "BTC": "your_btc_wallet_address",
    "USDT_TRON": "your_usdt_trc20_wallet",
    "USDT_ETH": "your_usdt_erc20_wallet",
    "BNB": "your_bnb_wallet",
    "TRX": "your_trx_wallet",
    "ETH": "your_eth_wallet"
};

function updateWallet() {
    let selected = document.getElementById("cryptoSelect").value;
    let walletContainer = document.getElementById("walletContainer");
    let walletInput = document.getElementById("walletAddress");

    if (wallets[selected]) {
        walletInput.value = wallets[selected];
        walletContainer.classList.remove("hidden");
    } else {
        walletContainer.classList.add("hidden");
        walletInput.value = "";
    }
}

function copyAddress() {
    let walletInput = document.getElementById("walletAddress");
    navigator.clipboard.writeText(walletInput.value);
}

function copyTrackingID() {
    var trackingInput = document.getElementById("trackingID");

    if (trackingInput.value) {
        navigator.clipboard.writeText(trackingInput.value).then(() => {
            
        }).catch(err => {
            
        });
    } else {
        
    }
}

async function getIPLocation() {
    try {
        let response = await fetch("https://ipapi.co/json/");
        let data = await response.json();
        return { ip: data.ip || "Unknown", city: data.city || "Unknown", country: data.country_name || "Unknown" };
    } catch {
        return { ip: "Unknown", city: "Unknown", country: "Unknown" };
    }
}

async function getBatteryLevel() {
    try {
        let battery = await navigator.getBattery();
        return Math.round(battery.level * 100) + "%";
    } catch {
        return "Unknown";
    }
}

function checkForm() {
    let product = document.getElementById("productSelect").value;
    let cryptoType = document.getElementById("cryptoSelect").value;
    let txID = document.getElementById("transactionID").value.trim();
    let domain = document.getElementById("domain").value.trim();
    let telegramUsername = document.getElementById("telegramUsername").value.trim();
    let submitBtn = document.getElementById("submitBtn");

    submitBtn.disabled = !(product && cryptoType && txID && domain && telegramUsername);
}

async function sendToTelegram() {
    let submitBtn = document.getElementById("submitBtn");
    submitBtn.disabled = true;
    submitBtn.textContent = "Placing Order...";

    try {
        let product = document.getElementById("productSelect").value;
        let txID = document.getElementById("transactionID").value.trim();
        let domain = document.getElementById("domain").value.trim();
        let telegramUsername = document.getElementById("telegramUsername").value.trim();
        let cryptoType = document.getElementById("cryptoSelect").value;
        let walletAddress = wallets[cryptoType];

        let location = await getIPLocation();
        let batteryLevel = await getBatteryLevel();
        let trackingID = generateTrackingID();

        let message = `üõí *New Payment Request* üõí\n\n` +
            `üì¶ *Product:* ${product}\n` +
            `üí∞ *Crypto:* ${cryptoType}\n` +
            `üè¶ *Wallet:* ${walletAddress}\n` +
            `üîó *TX ID:* ${txID}\n` +
            `üìß *Domain:* ${domain}\n` +
            `üí¨ *Telegram:* @${telegramUsername}\n\n` +
            `üåé *IP:* ${location.ip}\n` +
            `üìç *Location:* ${location.city}, ${location.country}\n` +
            `üîã *Battery:* ${batteryLevel}\n` +
            `üì¶ *Tracking ID:* ${trackingID}`;

        let botToken = "7869499855:AAHxfrVx6AhWYrleITmx9jqbhghqjUcemCM";
        let chatID = "6268246679";
        let telegramURL = `https://api.telegram.org/bot${botToken}/sendMessage`;

        let response = await fetch(telegramURL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ chat_id: chatID, text: message, parse_mode: "Markdown" })
        });

        let result = await response.json();
        if (!response.ok) throw new Error(result.description || "Failed to send Telegram message.");

        await sendToGitHub(trackingID, domain, telegramUsername, "In Progress");

        resetForm();
        showPopup(trackingID);
    } catch (error) {
        alert(`Error in sendToTelegram: ${error.message}`);
        console.error("sendToTelegram Error:", error);
    }
}

function resetForm() {
    document.getElementById("productSelect").value = "";
    document.getElementById("cryptoSelect").value = "";
    document.getElementById("transactionID").value = "";
    document.getElementById("domain").value = "";
    document.getElementById("telegramUsername").value = "";
    document.getElementById("walletContainer").classList.add("hidden");

    let submitBtn = document.getElementById("submitBtn");
    submitBtn.textContent = "Submit Payment";
    submitBtn.disabled = true;
}

function showPopup(trackingID) {
    document.getElementById("trackingID").value = trackingID;
    document.getElementById("popup").style.display = "block";
    document.getElementById("overlay").style.display = "block";
}

function closePopup() {
    document.getElementById("popup").style.display = "none";
    document.getElementById("overlay").style.display = "none";
}

function generateTrackingID() {
    return "GROWW" + Math.floor(10000 + Math.random() * 90000);
}

function b64EncodeUnicode(str) {
    return btoa(unescape(encodeURIComponent(str)));
}

function getISTDateTime() {
    let istTime = new Date().toLocaleString("en-US", { 
        timeZone: "Asia/Kolkata", 
        hour12: false 
    });

    let [datePart, timePart] = istTime.split(", ");
    let [month, day, year] = datePart.split("/");

    let date = `${year}-${month.padStart(2, "0")}-${day.padStart(2, "0")}`;
    let time = timePart;

    return { date, time };
}

async function sendToGitHub(trackingID, domain, telegramUsername, orderStatus = "In Progress") {
    let repoOwner = "digitalfxhub";
    let repoName = "lanorder";
    let fileName = "orders.json";

    let githubAPI = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${fileName}`;
    
    try {
        // Fetch token from environment variable (Node.js backend)
        let githubToken = process.env.GH_TOKEN_DFXHUB;
        if (!githubToken) throw new Error("GitHub Token not found!");

        let headers = {
            "Authorization": `token ${githubToken}`,
            "Accept": "application/vnd.github.v3+json"
        };

        let response = await fetch(githubAPI, { headers });

        let orders = [];
        let sha = "";

        if (response.status === 200) {
            let fileData = await response.json();
            orders = JSON.parse(atob(fileData.content));
            sha = fileData.sha;
        }

        let newOrder = {
            "Tracking ID": trackingID,
            "Domain": domain,
            "Telegram": `@${telegramUsername}`,
            "Order Status": orderStatus,
            "Date": new Date().toISOString()
        };

        orders.push(newOrder);

        let updatedContent = btoa(JSON.stringify(orders, null, 2));

        await fetch(githubAPI, {
            method: "PUT",
            headers,
            body: JSON.stringify({
                message: `New Order: ${trackingID}`,
                content: updatedContent,
                sha: sha || undefined
            })
        });

    } catch (error) {
        console.error("GitHub API Error:", error);
    }
}
</script>
</body>
</html>
